<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›³æ›¸é¤¨ ãƒ©ãƒ³ãƒ€ãƒ é¸æ›¸ã‚µãƒ¼ãƒ“ã‚¹</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f7f6; color: #333; }
        h1 { text-align: center; color: #444; margin-bottom: 20px; }
        
        .control-panel { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .row { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-search { background: #007bff; }
        .btn-search:hover { background: #0069d9; }
        /* ã‚¬ãƒãƒ£ã£ã½ã„è‰²å‘³ */
        .btn-random { background: linear-gradient(135deg, #e91e63, #9c27b0); } 
        .btn-random:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #resultArea { margin-top: 20px; display: none; }
        .book-card { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #eee; display: flex; gap: 15px; align-items: start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* è¡¨ç´™ç”»åƒãŒãªã„å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .book-cover { width: 80px; height: 110px; object-fit: cover; background: #eee; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 0.8em; font-weight: bold; text-align: center; }
        .no-img-placeholder { background-color: #f0f0f0; border: 1px dashed #ccc; }

        .book-details { flex-grow: 1; }
        .book-title { font-size: 1.1em; font-weight: bold; margin: 0 0 5px; }
        .book-author { font-size: 0.9em; color: #666; margin-bottom: 8px; }
        
        /* æ¤œç´¢ãƒ’ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚¸ */
        .keyword-badge { display: inline-block; background: #fce4ec; color: #c2185b; font-size: 0.8em; padding: 2px 8px; border-radius: 12px; margin-bottom: 5px; border: 1px solid #f8bbd0; }

        .lib-status { margin-top: 8px; font-size: 0.9em; min-height: 24px; }
        .status-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 0.85em; font-weight: bold; border: 1px solid transparent; }
        .ok { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .ng { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .waiting { background: #eee; color: #555; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; }
        .checking { color: #007bff; font-weight: bold; animation: blink 1.5s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }
        
        #huntStatus { font-weight: bold; color: #e91e63; }
        #statusLog { margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; height: 100px; overflow-y: scroll; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>ğŸ“š å›³æ›¸é¤¨ ãƒ©ãƒ³ãƒ€ãƒ é¸æ›¸ã‚µãƒ¼ãƒ“ã‚¹ ğŸ“š</h1>
    
    <div class="control-panel">
        <div class="row">
            <label>1. ã‚¨ãƒªã‚¢é¸æŠ</label>
            <select id="prefSelect"><option value="">éƒ½é“åºœçœŒã‚’é¸æŠ...</option></select>
            <select id="libSelect" disabled style="margin-top:10px;"><option value="">â†‘å…ˆã«éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„</option></select>
        </div>

        <div class="row">
            <label>2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
            <div class="btn-group">
                <button onclick="startNormalSearch()" class="btn-search">ISBNæŒ‡å®šæ¤œç´¢</button>
                <button onclick="startRandomHunt()" class="btn-random">ãƒ©ãƒ³ãƒ€ãƒ é¸æ›¸</button>
            </div>
            <input type="text" id="isbnInput" value="9784101061412" placeholder="ISBN (é€šå¸¸æ¤œç´¢ç”¨)" style="margin-top:10px; font-family: monospace;">
        </div>
    </div>

    <div id="resultArea">
        <h3 style="border-bottom:2px solid #ddd; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>æ¤œç´¢çµæœ</span>
            <span id="huntStatus"></span>
        </h3>
        <div id="bookList"></div>
    </div>

    <div id="statusLog">æº–å‚™å®Œäº†</div>

    <script>
        const PREF_LIST = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"];
        
        // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆç”¨ã²ã‚‰ãŒãªãƒªã‚¹ãƒˆ
        const HIRAGANA = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¾ã¿ã‚€ã‚ã‚‚ã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";

        $(document).ready(function(){
            PREF_LIST.forEach(p => $('#prefSelect').append(new Option(p, p)));
            $('#prefSelect').change(function() { if($(this).val()) fetchLibraries($(this).val()); });
        });

        function log(msg) {
            const div = $('#statusLog');
            const t = new Date().toLocaleTimeString();
            div.prepend(`[${t}] ${msg}<br>`);
        }

        // --- å›³æ›¸é¤¨ãƒªã‚¹ãƒˆå–å¾— ---
        function fetchLibraries(pref) {
            $('#libSelect').prop('disabled', true).html('<option>å–å¾—ä¸­...</option>');
            $.ajax({
                url: `https://api.calil.jp/library?appkey=&pref=${encodeURIComponent(pref)}&format=json`,
                dataType: 'jsonp',
                success: function(data) {
                    const sel = $('#libSelect').empty().append('<option value="">å›³æ›¸é¤¨ã‚’é¸æŠ</option>');
                    const seen = new Set();
                    data.forEach(l => {
                        if (!seen.has(l.systemid)) {
                            seen.add(l.systemid);
                            sel.append(new Option(l.systemname, l.systemid));
                        }
                    });
                    sel.prop('disabled', false);
                    log(`${pref}ã®å›³æ›¸é¤¨ã‚’å–å¾—å®Œäº†ï¼ˆ${seen.size}ä»¶ï¼‰`);
                },
                error: function() { log('å›³æ›¸é¤¨ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—'); }
            });
        }

        // --- é€šå¸¸æ¤œç´¢ ---
        async function startNormalSearch() {
            const isbn = $('#isbnInput').val().replace(/[^0-9]/g, '');
            const systemId = $('#libSelect').val();
            if(!systemId) return alert('å›³æ›¸é¤¨ã‚’é¸ã‚“ã§ãã ã•ã„');
            if(isbn.length !== 13) return alert('ISBNã¯13æ¡ã§');
            
            $('#resultArea').show();
            $('#bookList').empty();
            log(`æŒ‡å®šæ¤œç´¢é–‹å§‹: ${isbn}`);
            
            const bookDataList = await fetchOpenBDBulk([isbn]);
            renderBookCards(bookDataList);
            checkLibraryBatch([isbn], systemId);
        }

        // --- â˜…ãƒ©ãƒ³ãƒ€ãƒ 10å†Šãƒãƒ³ãƒˆï¼ˆ2æ–‡å­—ã‚¬ãƒãƒ£ï¼‰ ---
        async function startRandomHunt() {
            const systemId = $('#libSelect').val();
            if(!systemId) return alert('å›³æ›¸é¤¨ã‚’é¸ã‚“ã§ãã ã•ã„');

            $('button').prop('disabled', true);
            $('#resultArea').show();
            $('#bookList').html('<p style="text-align:center; padding:20px; color:#666;">2æ–‡å­—ã®è¨€è‘‰ã‚’ç”Ÿæˆã—ã¦æœ¬ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>');
            $('#huntStatus').text('é¸æ›¸ä¸­...');
            
            log('ãƒ©ãƒ³ãƒ€ãƒ é¸å®šé–‹å§‹...');

            try {
                // 1. 2æ–‡å­—ã‚¬ãƒãƒ£ã§æœ¬ã‚’10å†Šé›†ã‚ã‚‹
                let verifiedBooks = await huntBooksByRandomPairs(10);
                
                if (verifiedBooks.length === 0) {
                    throw new Error("æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
                }

                log(`${verifiedBooks.length}å†Šç¢ºå®šã€‚`);
                $('#bookList').empty();
                $('#huntStatus').text('ãƒªã‚¹ãƒˆä½œæˆå®Œäº†');

                // 2. ç”»é¢æç”»
                renderBookCards(verifiedBooks);
                
                const isbnList = verifiedBooks.map(b => b.summary.isbn);

                // 3. å•ã„åˆã‚ã›é–‹å§‹
                log('1ç§’å¾Œã«å›³æ›¸é¤¨ã¸å•ã„åˆã‚ã›ã¾ã™...');
                setTimeout(() => {
                    $('#huntStatus').text('å›³æ›¸é¤¨ã¸å•ã„åˆã‚ã›ä¸­...');
                    $('.lib-status').html('<span class="checking">å›³æ›¸é¤¨ã«å•ã„åˆã‚ã›ä¸­...</span>');
                    checkLibraryBatch(isbnList, systemId);
                }, 1000);

            } catch (e) {
                log('ã‚¨ãƒ©ãƒ¼: ' + e);
                $('#bookList').html(`<p style="color:red; text-align:center;">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`);
                $('button').prop('disabled', false);
            }
        }

        // --- ã€æ–°å®Ÿè£…ã€‘ãƒ©ãƒ³ãƒ€ãƒ 2æ–‡å­—ç”Ÿæˆï¼†æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function huntBooksByRandomPairs(targetCount) {
            let candidates = [];
            let retry = 0;
            // 2æ–‡å­—ã ã¨ãƒ’ãƒƒãƒˆã—ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã‚’é«˜ã‚ã«è¨­å®š(30å›)
            const MAX_RETRY = 30;

            while (candidates.length < targetCount && retry < MAX_RETRY) {
                retry++;
                
                // â˜…2æ–‡å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
                const char1 = HIRAGANA[Math.floor(Math.random() * HIRAGANA.length)];
                const char2 = HIRAGANA[Math.floor(Math.random() * HIRAGANA.length)];
                const q = char1 + char2;
                
                log(`ã€Œ${q}ã€ã§æ¤œç´¢ä¸­... (${candidates.length}/${targetCount}å†Š)`);

                // ãƒ’ãƒƒãƒˆç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ intitle: (ã‚¿ã‚¤ãƒˆãƒ«ã«å«ã¾ã‚Œã‚‹) ã§æ¤œç´¢
                // æ„å‘³ã®ãªã„æ–‡å­—åˆ—ã ã¨0ä»¶ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã®ã§ã€ã©ã‚“ã©ã‚“ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹è¨­è¨ˆ
                const startIndex = Math.floor(Math.random() * 5); // å°‘ã—ã°ã‚‰ã‘ã•ã›ã‚‹
                const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=20&startIndex=${startIndex}&printType=books`;

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.items) {
                        const tempIsbns = [];
                        for (const item of data.items) {
                            const ids = item.volumeInfo.industryIdentifiers;
                            if (ids) {
                                const isbn13 = ids.find(id => id.type === "ISBN_13");
                                // æ—¥æœ¬ã®ISBN(9784...)ã®ã¿å¯¾è±¡
                                if (isbn13 && isbn13.identifier.startsWith('9784')) {
                                    tempIsbns.push(isbn13.identifier);
                                }
                            }
                        }
                        
                        // é‡è¤‡é™¤å»
                        const uniqueIsbns = [...new Set(tempIsbns)];

                        if (uniqueIsbns.length > 0) {
                            // OpenBDã§å®Ÿåœ¨ç¢ºèªï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚‹ã‹ï¼‰
                            const verified = await fetchOpenBDBulk(uniqueIsbns);
                            
                            for (const book of verified) {
                                if (book && book.summary && book.summary.title) {
                                    // æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚‹æœ¬ã¯é™¤å¤–
                                    if (!candidates.find(c => c.summary.isbn === book.summary.isbn)) {
                                        // â˜…æ¤œç´¢ã«ä½¿ã£ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ¼ã‚¿ã«ä»˜ä¸ã—ã¦ãŠãï¼ˆè¡¨ç¤ºç”¨ï¼‰
                                        book.searchKeyword = q;
                                        candidates.push(book);
                                    }
                                }
                                if (candidates.length >= targetCount) break;
                            }
                        }
                    } else {
                        // ãƒ’ãƒƒãƒˆ0ä»¶ã®å ´åˆ
                        // log(`ã€Œ${q}ã€ã¯ãƒ’ãƒƒãƒˆãªã—`);
                    }
                } catch (e) { console.error(e); }
                
                // APIåˆ¶é™å›é¿ã®ãŸã‚å°‘ã—å¾…æ©Ÿï¼ˆä»»æ„ï¼‰
                await new Promise(r => setTimeout(r, 200));
            }
            
            return candidates.slice(0, targetCount);
        }

        // --- OpenBDä¸€æ‹¬å–å¾— ---
        async function fetchOpenBDBulk(isbnList) {
            if (isbnList.length === 0) return [];
            // URLé•·åˆ¶é™å¯¾ç­–ã®ãŸã‚ã€ã‚ã¾ã‚Šã«å¤šã„å ´åˆã¯åˆ†å‰²ã™ã¹ãã§ã™ãŒä»Šå›ã¯ç°¡æ˜“å®Ÿè£…
            const uniqueIsbns = [...new Set(isbnList)].join(',');
            try {
                const res = await fetch('https://api.openbd.jp/v1/get?isbn=' + uniqueIsbns);
                const json = await res.json();
                return json; 
            } catch(e) { return []; }
        }

        // --- ç”»é¢æç”» ---
        function renderBookCards(bookDataList) {
            bookDataList.forEach(bookData => {
                if (!bookData || !bookData.summary) return;

                const b = bookData.summary;
                const isbn = b.isbn;
                const title = b.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
                const author = b.author || "";
                const coverSrc = b.cover || "";
                const keyword = bookData.searchKeyword || ""; // æ¤œç´¢ã«ä½¿ã£ãŸ2æ–‡å­—
                
                const imgStyle = coverSrc ? "" : "display:none;";
                const noImgClass = coverSrc ? "" : "no-img";
                
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚¸ã®HTMLç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ¤œç´¢æ™‚ã®ã¿è¡¨ç¤ºï¼‰
                const keywordHtml = keyword ? `<span class="keyword-badge">æ¤œç´¢èª: ${keyword}</span>` : "";

                const html = `
                    <div class="book-card" id="card-${isbn}">
                        <div class="book-cover ${noImgClass}">
                            ${coverSrc ? `<img src="${coverSrc}" style="width:100%; height:100%; object-fit:cover;">` : 'NO<br>IMAGE'}
                        </div>
                        <div class="book-details">
                            ${keywordHtml}
                            <div class="book-title">${title}</div>
                            <div class="book-author">${author}</div>
                            <div class="lib-status" id="status-${isbn}">
                                <span class="waiting">è”µæ›¸ç¢ºèªå¾…æ©Ÿä¸­...</span>
                            </div>
                        </div>
                    </div>
                `;
                $('#bookList').append(html);
            });
        }

        // --- å›³æ›¸é¤¨ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯ ---
        function checkLibraryBatch(isbnList, systemId, retryCount = 0) {
            const isbnStr = isbnList.join(',');
            const ts = new Date().getTime();

            $.ajax({
                url: `https://api.calil.jp/check?appkey=&isbn=${isbnStr}&systemid=${systemId}&_=${ts}`,
                dataType: 'jsonp',
                jsonp: 'callback',
                success: function(data) {
                    if(data.status === 'Error') {
                        log('APIã‚¨ãƒ©ãƒ¼');
                        $('button').prop('disabled', false);
                        return;
                    }

                    updateStatusDisplay(data, isbnList, systemId);

                    if (data.continue === 1) {
                        setTimeout(() => pollingBatch(data.session, isbnList, systemId, retryCount), 2000);
                    } else {
                        log('å…¨ä»¶æ¤œç´¢å®Œäº†');
                        $('#huntStatus').text('å®Œäº†');
                        $('button').prop('disabled', false);
                    }
                },
                error: function() { 
                    log('é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å†è©¦è¡Œã—ã¾ã™ã€‚');
                    if(retryCount < 2) setTimeout(() => checkLibraryBatch(isbnList, systemId, retryCount + 1), 2000);
                    else $('button').prop('disabled', false);
                }
            });
        }

        function pollingBatch(session, isbnList, systemId, totalRetry) {
            const ts = new Date().getTime();
            $.ajax({
                url: `https://api.calil.jp/polling?appkey=&session=${session}&format=json&_=${ts}`,
                dataType: 'jsonp',
                jsonp: 'callback',
                success: function(data) {
                    updateStatusDisplay(data, isbnList, systemId);
                    
                    if (data.continue === 1) {
                        setTimeout(() => pollingBatch(session, isbnList, systemId, totalRetry), 2000);
                    } else {
                        log('å…¨ä»¶æ¤œç´¢å®Œäº†');
                        $('#huntStatus').text('å®Œäº†');
                        $('button').prop('disabled', false);
                    }
                },
                error: function() {
                    if (totalRetry < 2) {
                        log('æ¥ç¶šãƒªã‚»ãƒƒãƒˆã€‚å†æ¥ç¶šä¸­...');
                        setTimeout(() => checkLibraryBatch(isbnList, systemId, totalRetry + 1), 2000);
                    } else {
                        $('button').prop('disabled', false);
                    }
                }
            });
        }

        function updateStatusDisplay(data, isbnList, systemId) {
            if (!data.books) return;

            isbnList.forEach(isbn => {
                const sys = data.books[isbn] && data.books[isbn][systemId];
                const statusDiv = $(`#status-${isbn}`);

                if (!sys || !sys.libkey || Object.keys(sys.libkey).length === 0) {
                    if (data.continue === 0) {
                        statusDiv.html('<span style="color:#aaa; font-size:0.9em;">è”µæ›¸ãªã—</span>');
                    }
                    return;
                }

                let html = '';
                for (const lib in sys.libkey) {
                    const st = sys.libkey[lib];
                    const cls = st === 'è²¸å‡ºå¯' ? 'ok' : 'ng';
                    html += `<span class="status-tag ${cls}">${lib}: ${st}</span>`;
                }
                
                if(sys.reserveurl) {
                   html += ` <a href="${sys.reserveurl}" target="_blank" style="font-size:0.8em; margin-left:5px; color:#007bff;">äºˆç´„ â†—</a>`;
                }
                statusDiv.html(html);
            });
        }
    </script>
</body>
</html>
